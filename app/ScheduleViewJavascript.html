<!-- ScheduleViewJavascript.html -->
<script>
    function showLoading() {
        const loadingDiv = document.getElementById("loading");
        if (loadingDiv) loadingDiv.style.display = "flex";
        const messageDiv = document.getElementById("message");
        if (messageDiv) {
            messageDiv.textContent = "";
            messageDiv.className = "message";
            messageDiv.style.display = 'none';
        }
    }

    function hideLoading() {
        const loadingDiv = document.getElementById("loading");
        if (loadingDiv) loadingDiv.style.display = "none";
    }

    function displayMessage(text, type = 'info') {
        const messageDiv = document.getElementById("message");
        if (messageDiv) {
            messageDiv.textContent = text;
            messageDiv.className = "message " + type;
            messageDiv.style.display = text ? 'block' : 'none';
        }
    }

    function populateDropdown(selectId, optionsArray, defaultText = "-- Selecione --") {
        const selectElement = document.getElementById(selectId);
        if (!selectElement) {
            console.warn("Dropdown com ID '" + selectId + "' não encontrado.");
            return;
        }

        selectElement.innerHTML = `<option value="" disabled selected>${defaultText}</option>`;

        if (optionsArray && Array.isArray(optionsArray)) {
            optionsArray.forEach(optionItem => {
                const value = typeof optionItem === 'object' && optionItem !== null && optionItem.hasOwnProperty('value') ? String(optionItem.value).trim() : String(optionItem).trim();
                const text = typeof optionItem === 'object' && optionItem !== null && optionItem.hasOwnProperty('text') ? String(optionItem.text).trim() : value;

                if (value !== '') {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = text;
                    selectElement.appendChild(option);
                }
            });
        }
        selectElement.disabled = false;

        if (selectElement.selectedIndex === -1) {
             selectElement.selectedIndex = 0;
        }
    }

    function formatYYYYMMDDToDDMMYYYY(dateString) {
         const parts = dateString.split('-');
         if (parts.length === 3) {
             const dateObj = new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
             if (!isNaN(dateObj.getTime()) && dateObj.getFullYear() == parts[0] && (dateObj.getMonth() + 1) == parts[1] && dateObj.getDate() == parts[2] ) {
                 const day = String(dateObj.getDate()).padStart(2, '0');
                 const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                 const year = dateObj.getFullYear();
                 return `${day}/${month}/${year}`;
             }
         }
         return dateString;
    }

    function formatCellContent(mainContent, status) {
        const statusText = status && status.trim() !== '' ? status.trim() : 'Status Desconhecido';
        const statusSpan = `<span class="slot-status">(${statusText})</span>`;

        if (mainContent && mainContent.trim() !== '') {
            return `${mainContent.trim()}<br>${statusSpan}`;
        } else {
             return statusSpan;
        }
    }

    function loadFilterOptions() {
        showLoading();
        google.script.run
            .withSuccessHandler(onFilterOptionsLoaded)
            .withFailureHandler(onFilterOptionsFailed)
            .getScheduleViewFilters();
    }

    function onFilterOptionsLoaded(jsonStringResponse) {
        hideLoading();
        let response;
        try {
            response = JSON.parse(jsonStringResponse);
            console.log("Filter options response:", response);
        } catch (e) {
            console.error("Erro ao parsear JSON de filtros:", e, jsonStringResponse);
            displayMessage('Erro ao processar filtros de horários.', 'error');
            populateDropdown('turma-filter', [], '-- Erro ao Carregar Turmas --');
            populateDropdown('week-filter', [], '-- Erro ao Carregar Semanas --');
            return;
        }

        if (!response || !response.success) {
            const errorMessage = (response && response.message) ? response.message : 'Erro desconhecido ao carregar filtros.';
            console.error("Falha ao carregar filtros:", errorMessage, response);
            displayMessage(errorMessage, 'error');
            populateDropdown('turma-filter', [], '-- Erro ao Carregar Turmas --');
            populateDropdown('week-filter', [], '-- Erro ao Carregar Semanas --');
            return;
        }

        const data = response.data;

        if (data && Array.isArray(data.turmas) && Array.isArray(data.weekStartDates)) {

            populateDropdown('turma-filter', data.turmas, '-- Selecione a Turma --');

            const weeksForDropdown = data.weekStartDates.map(dateString => {
                 if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                     const formattedDate = formatYYYYMMDDToDDMMYYYY(dateString);
                     if (formattedDate !== dateString) {
                         return { value: dateString, text: `Semana de ${formattedDate}` };
                     }
                 }
                 return { value: dateString, text: dateString };
             }).filter(item => item.value);


            populateDropdown('week-filter', weeksForDropdown, '-- Selecione a Semana --');

            displayMessage('Filtros carregados. Selecione e busque o horário.', 'info');

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const currentDayOfWeek = today.getDay();
            const mondayOfCurrentWeek = new Date(today);
             mondayOfCurrentWeek.setDate(today.getDate() - (currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1));
            const currentWeekString = mondayOfCurrentWeek.toISOString().slice(0, 10);

            const weekSelect = document.getElementById('week-filter');
            if (weekSelect && weeksForDropdown.length > 0) {
                 const optionToSelect = weekSelect.querySelector(`option[value="${currentWeekString}"]`);

                 if (optionToSelect) {
                      optionToSelect.selected = true;
                 } else {
                      if (weekSelect.options.length > 1) {
                           weekSelect.selectedIndex = 1;
                      }
                 }
            }


        } else {
            displayMessage('Dados de filtros incompletos ou em formato inesperado.', 'error');
            populateDropdown('turma-filter', [], '-- Erro ao Carregar Turmas --');
            populateDropdown('week-filter', [], '-- Erro ao Carregar Semanas --');
        }
    }

    function onFilterOptionsFailed(error) {
        hideLoading();
        console.error("Erro na comunicação ao carregar filtros:", error);
        displayMessage('Erro na comunicação com o servidor ao carregar filtros: ' + error.message, 'error');
        populateDropdown('turma-filter', [], '-- Erro ao Carregar Turmas --');
        populateDropdown('week-filter', [], '-- Erro ao Carregar Semanas --');
    }

    function loadFilteredSchedule() {
        const turmaFilter = document.getElementById('turma-filter');
        const weekFilter = document.getElementById('week-filter');
        const scheduleContainer = document.getElementById('schedule-container');

        if (scheduleContainer) {
            scheduleContainer.innerHTML = '<p class="info-message">Carregando horário...</p>';
        }
        displayMessage('');

        const selectedTurma = turmaFilter ? turmaFilter.value : '';
        const selectedWeek = weekFilter ? weekFilter.value : '';

        if (!selectedTurma) {
            displayMessage('Por favor, selecione a Turma.', 'error');
            if (scheduleContainer) scheduleContainer.innerHTML = '<p class="info-message">Selecione a Turma e a Semana e clique em "Buscar Horário".</p>';
            return;
        }

        if (!selectedWeek) {
            displayMessage('Por favor, selecione a Semana.', 'error');
            if (scheduleContainer) scheduleContainer.innerHTML = '<p class="info-message">Selecione a Turma e a Semana e clique em "Buscar Horário".</p>';
            return;
        }

        showLoading();

        google.script.run
            .withSuccessHandler(onScheduleLoaded)
            .withFailureHandler(onScheduleLoadFailed)
            .getFilteredScheduleInstances(selectedTurma, selectedWeek);
    }

    function onScheduleLoaded(jsonStringResponse) {
        hideLoading();
        const scheduleContainer = document.getElementById('schedule-container');
        if (!scheduleContainer) {
            console.error("Schedule container not found!");
            displayMessage('Erro interno: Container de horário não encontrado.', 'error');
            return;
        }
        scheduleContainer.innerHTML = '';

        let response;
        try {
            response = JSON.parse(jsonStringResponse);
            console.log("Filtered schedule response:", response);
        } catch (e) {
            console.error("Erro ao parsear JSON de horários filtrados:", e, jsonStringResponse);
            displayMessage('Erro ao processar dados de horários filtrados.', 'error');
            scheduleContainer.innerHTML = '<p class="error-message">Erro ao carregar horário.</p>';
            return;
        }

        if (!response || !response.success) {
            const errorMessage = (response && response.message) ? response.message : 'Erro desconhecido ao carregar horários.';
            console.error("Falha ao carregar horários filtrados:", errorMessage, response);
            displayMessage(errorMessage, 'error');
            scheduleContainer.innerHTML = '<p class="error-message">' + errorMessage + '</p>';
            return;
        }

        const slots = response.data;

        if (!Array.isArray(slots) || slots.length === 0) {
            displayMessage(response.message || 'Nenhum horário encontrado para a turma e semana selecionadas.', 'info');
            scheduleContainer.innerHTML = '<p class="info-message">Nenhum horário encontrado para os filtros selecionados.</p>';
            return;
        }

        displayMessage(response.message || 'Horário carregado com sucesso.', 'success');
        renderScheduleTable(slots, scheduleContainer);
    }

    function onScheduleLoadFailed(error) {
        hideLoading();
        console.error("Erro na comunicação ao carregar horários:", error);
        displayMessage('Erro na comunicação com o servidor ao buscar horários: ' + error.message, 'error');
        const scheduleContainer = document.getElementById('schedule-container');
        if (scheduleContainer) {
            scheduleContainer.innerHTML = '<p class="error-message">Erro ao carregar horário.</p>';
        }
    }

    function renderScheduleTable(slots, containerElement) {
        const daysOfWeek = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
        const dayIndexMap = {
            'Segunda': 0,
            'Terça': 1,
            'Quarta': 2,
            'Quinta': 3,
            'Sexta': 4,
            'Sábado': 5,
            'Domingo': 6
        };
        const gridData = {};
        const uniqueHours = new Set();

        slots.forEach(slot => {
            if (slot && slot.diaSemana && slot.horaInicio) {
                const dayIndex = dayIndexMap[slot.diaSemana];
                if (dayIndex !== undefined) {
                    if (!gridData[dayIndex]) gridData[dayIndex] = {};
                    gridData[dayIndex][slot.horaInicio] = slot;
                    uniqueHours.add(slot.horaInicio);
                } else {
                    console.warn("Slot com Dia da Semana inválido:", slot);
                }
            } else {
                console.warn("Slot inválido ou incompleto:", slot);
            }
        });
        const sortedHours = Array.from(uniqueHours).sort();
        const table = document.createElement('table');
        table.classList.add('schedule-grid-table');
        const thead = table.createTHead();
        const headerRow = thead.insertRow();
        const emptyTh = document.createElement('th');
        headerRow.appendChild(emptyTh);
        daysOfWeek.forEach(day => {
            const th = document.createElement('th');
            th.textContent = day;
            headerRow.appendChild(th);
        });
        const tbody = table.createTBody();
        sortedHours.forEach(hour => {
            const row = tbody.insertRow();
            const hourCell = row.insertCell();
            hourCell.textContent = hour;
            hourCell.classList.add('hour-cell');
            daysOfWeek.forEach(day => {
                const dayIndex = dayIndexMap[day];
                const cell = row.insertCell();
                const slot = gridData[dayIndex] ? gridData[dayIndex][hour] : null;
                if (slot) {
                    let mainContent = '';
                    let cellClass = 'slot-cell';
                    if (slot.statusOcupacao === 'Disponivel') {
                        cellClass += ' slot-available';
                         if(slot.tipoOriginal === 'Fixo' && slot.professorPrincipal && slot.professorPrincipal.trim() !== '') {
                              mainContent = slot.professorPrincipal.trim();
                              cellClass += ' slot-fixed-available';
                         } else if (slot.tipoOriginal === 'Vago') {
                             mainContent = 'Vago';
                              cellClass += ' slot-vago-available';
                         } else {
                              mainContent = slot.tipoOriginal || 'Horário';
                         }
                    } else if (slot.statusOcupacao === 'Reposicao Agendada') {
                        mainContent = slot.professorPrincipal && slot.professorPrincipal.trim() !== '' ? slot.professorPrincipal.trim() : 'Reposição';
                        cellClass += ' slot-booked slot-reposicao';
                    } else if (slot.statusOcupacao === 'Substituicao Agendada') {
                        mainContent = slot.professorPrincipal && slot.professorPrincipal.trim() !== '' ? slot.professorPrincipal.trim() : 'Substituição';
                        cellClass += ' slot-booked slot-substituicao';
                    } else {
                         mainContent = slot.tipoOriginal || 'Horário';
                         cellClass += ' slot-unknown-status';
                    }
                    cell.innerHTML = formatCellContent(mainContent, slot.statusOcupacao);
                    cell.title =
                        `ID: ${slot.idInstancia}\nData: ${slot.data}\nHora: ${slot.horaInicio}\nTurma: ${slot.turma}\nTipo: ${slot.tipoOriginal}\nStatus: ${slot.statusOcupacao}\nProf. Base: ${slot.professorPrincipal || '-'}`;
                    cell.className = cellClass;
                } else {
                    cell.classList.add('slot-cell', 'slot-empty');
                }
            });
        });
        containerElement.appendChild(table);
    }

    document.addEventListener('DOMContentLoaded', function () {
        console.log("ScheduleView DOM loaded. Loading filter options.");
        loadFilterOptions();
    });
</script>
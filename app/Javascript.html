<!-- Javascript.html -->
<script>
    const DEBUG_MODE = true;
    function logDebug(...args) {
        if (DEBUG_MODE) {
            console.log("[DEBUG]", ...args);
        }
    }
    let currentUserRole = null;
    let currentUserProfessorName = null;
    const ABSENCE_DEBUG = true;
    function logAbsenceDebug(...args) {
        if (ABSENCE_DEBUG) {
            console.log("[ABSENCE DEBUG]", ...args);
        }
    }
    function showLoading() {
        logDebug("showLoading called");
        const loadingDiv = document.getElementById("loading");
        if (loadingDiv) {
            loadingDiv.style.display = "flex";
        } else {
            console.warn("Element with ID 'loading' not found.");
        }
        const messageDiv = document.getElementById("message");
        if (messageDiv) {
            messageDiv.textContent = "";
            messageDiv.className = "message";
            messageDiv.style.display = 'none';
        } else {
            console.warn("Element with ID 'message' not found.");
        }
    }
    function hideLoading() {
        logDebug("hideLoading called");
        const loadingDiv = document.getElementById("loading");
        if (loadingDiv) {
            loadingDiv.style.display = "none";
        } else {
            console.warn("Element with ID 'loading' not found.");
        }
    }
    function displayMessage(text, type = 'info') {
        const messageDiv = document.getElementById("message");
        logDebug(`displayMessage called with text: "${text}", type: "${type}"`);
        if (messageDiv) {
            messageDiv.textContent = text;
            messageDiv.className = "message " + type;
            const show = (text && String(text).trim() !== '');
            messageDiv.style.display = show ? 'block' : 'none';
            logDebug(`Message div display set to: ${messageDiv.style.display}`);
            if (show && (type === 'error' || type === 'success')) {
                logDebug("Scrolling message into view.");
                try {
                    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } catch (scrollError) {
                    console.warn("Scrolling message into view failed:", scrollError);
                    messageDiv.scrollIntoView();
                }
            }
        } else {
            console.warn("Element with ID 'message' not found.");
        }
    }
    function populateDropdown(selectId, optionsArray, defaultText = "-- Selecione --") {
        logDebug(`populateDropdown called for ID: '${selectId}', Options count: ${Array.isArray(optionsArray) ? optionsArray.length : 'N/A'}, Default text: '${defaultText}'`);
        const selectElement = document.getElementById(selectId);
        if (!selectElement) {
            console.warn(`Dropdown com ID '${selectId}' n√£o encontrado.`);
            return;
        }
        let placeholderFound = false;
        for (let i = selectElement.options.length - 1; i >= 0; i--) {
            if (selectElement.options[i].value === "") {
                placeholderFound = true;
                logDebug(`Placeholder found in '${selectId}'. Keeping it.`);
                selectElement.options[i].textContent = defaultText;
                selectElement.options[i].disabled = true;
                selectElement.options[i].selected = true;
            } else {
                selectElement.remove(i);
            }
        }
        if (!placeholderFound) {
            logDebug(`No placeholder found in '${selectId}'. Adding one.`);
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = defaultText;
            defaultOption.disabled = true;
            defaultOption.selected = true;
            if (selectElement.firstChild) {
                selectElement.insertBefore(defaultOption, selectElement.firstChild);
            } else {
                selectElement.appendChild(defaultOption);
            }
        }
        selectElement.selectedIndex = 0;
        let addedCount = 0;
        if (optionsArray && Array.isArray(optionsArray)) {
            optionsArray.forEach((optionItem, index) => {
                const value = typeof optionItem === 'object' && optionItem !== null && optionItem.hasOwnProperty('value') ? String(optionItem.value).trim() : String(optionItem).trim();
                const text = typeof optionItem === 'object' && optionItem !== null && optionItem.hasOwnProperty('text') ? String(optionItem.text).trim() : value;
                if (value !== '') {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = text;
                    selectElement.appendChild(option);
                    addedCount++;
                } else {
                    logDebug(`Skipped empty option at index ${index}`);
                }
            });
        }
        selectElement.disabled = false;
        logDebug(`Finished populating '${selectId}'. Added ${addedCount} options. Total options (incl. placeholder): ${selectElement.options.length}`);
        if (selectElement.selectedIndex === -1 || selectElement.selectedIndex === 0) {
            selectElement.selectedIndex = 0;
            logDebug(`Placeholder remains selected for '${selectId}'.`);
        }
    }
    function formatYYYYMMDDToDDMMYYYY(dateString) {
        if (!dateString || typeof dateString !== 'string') {
            logDebug("formatYYYYMMDDToDDMMYYYY: Input is not a valid string, returning original.");
            return dateString;
        }
        const parts = dateString.split('-');
        if (parts.length === 3) {
            if (!/^\d{4}$/.test(parts[0]) || !/^\d{2}$/.test(parts[1]) || !/^\d{2}$/.test(parts[2])) {
                logDebug("formatYYYYMMDDToDDMMYYYY: Input does not match YYYY-MM-DD pattern, returning original.");
                return dateString;
            }
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const day = parseInt(parts[2], 10);
            if (year > 1000 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                const dateObj = new Date(Date.UTC(year, month - 1, day));
                if (!isNaN(dateObj.getTime()) && dateObj.getUTCFullYear() === year && (dateObj.getUTCMonth() + 1) === month && dateObj.getUTCDate() === day) {
                    const formattedDay = String(day).padStart(2, '0');
                    const formattedMonth = String(month).padStart(2, '0');
                    const result = `${formattedDay}/${formattedMonth}/${year}`;
                    return result;
                } else {
                    logDebug(`formatYYYYMMDDToDDMMYYYY: Date object validation failed for Y=${year}, M=${month}, D=${day}. Returning original.`);
                    return dateString;
                }
            } else {
                logDebug(`formatYYYYMMDDToDDMMYYYY: Date components out of basic range (Y=${year}, M=${month}, D=${day}). Returning original.`);
                return dateString;
            }
        }
        logDebug("formatYYYYMMDDToDDMMYYYY: Input does not have 3 parts separated by '-', returning original.");
        return dateString;
    }
    function loadFilterOptions() {
        logDebug("loadFilterOptions called");
        google.script.run
            .withSuccessHandler(onFilterOptionsLoaded)
            .withFailureHandler(onFilterOptionsFailed)
            .getScheduleViewFilters();
    }
    function onFilterOptionsLoaded(jsonStringResponse) {
        logDebug("onFilterOptionsLoaded called with response string (length):", jsonStringResponse?.length);
        let response;
        try {
            if (!jsonStringResponse) throw new Error("Response string is empty or null.");
            response = JSON.parse(jsonStringResponse);
            logDebug("Filter options response parsed successfully:", response);
        } catch (e) {
            console.error("Erro ao parsear JSON de filtros:", e, jsonStringResponse);
            displayMessage('Erro ao processar filtros de hor√°rios.', 'error');
            populateDropdown('turma-filter', [], '-- Erro Turmas --');
            populateDropdown('week-filter', [], '-- Erro Semanas --');
            return;
        }
        if (!response || !response.success) {
            const errorMessage = (response && response.message) ? response.message : 'Erro desconhecido ao carregar filtros.';
            console.error("Falha ao carregar filtros:", errorMessage, response);
            displayMessage(errorMessage, 'error');
            populateDropdown('turma-filter', [], '-- Erro Turmas --');
            populateDropdown('week-filter', [], '-- Erro Semanas --');
            return;
        }
        const data = response.data;
        if (data && Array.isArray(data.turmas) && Array.isArray(data.weekStartDates)) {
            logDebug("Populating Turma filter dropdown.");
            populateDropdown('turma-filter', data.turmas, '-- Selecione a Turma --');
            logDebug("Processing week start dates for dropdown.");
            const weeksForDropdown = data.weekStartDates.map(dateString => {
                const formattedDate = formatYYYYMMDDToDDMMYYYY(dateString);
                const displayText = (formattedDate !== dateString) ? `Semana de ${formattedDate}` : dateString;
                return { value: dateString, text: displayText };
            }).filter(item => item.value);
            logDebug(`Processed ${weeksForDropdown.length} weeks for dropdown.`);
            logDebug("Populating Week filter dropdown.");
            populateDropdown('week-filter', weeksForDropdown, '-- Selecione a Semana --');
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const currentDayOfWeek = today.getDay();
                const mondayOfCurrentWeek = new Date(today);
                const daysToSubtract = (currentDayOfWeek === 0) ? 6 : currentDayOfWeek - 1;
                mondayOfCurrentWeek.setDate(today.getDate() - daysToSubtract);
                const year = mondayOfCurrentWeek.getFullYear();
                const month = String(mondayOfCurrentWeek.getMonth() + 1).padStart(2, '0');
                const day = String(mondayOfCurrentWeek.getDate()).padStart(2, '0');
                const currentWeekString = `${year}-${month}-${day}`;
                logDebug("Calculated current week start date for auto-select:", currentWeekString);
                const weekSelect = document.getElementById('week-filter');
                if (weekSelect) {
                    logDebug("Found week-filter select element.");
                    let foundOption = false;
                    for (let i = 0; i < weekSelect.options.length; i++) {
                        if (weekSelect.options[i].value === currentWeekString) {
                            weekSelect.selectedIndex = i;
                            foundOption = true;
                            logDebug(`Current week '${currentWeekString}' found at index ${i} and selected.`);
                            break;
                        }
                    }
                    if (!foundOption) {
                        logDebug(`Current week '${currentWeekString}' not found in options. Defaulting to first week (index 1 if available).`);
                        if (weekSelect.options.length > 1) {
                            weekSelect.selectedIndex = 1;
                        } else {
                            weekSelect.selectedIndex = 0;
                        }
                    }
                } else {
                    console.warn("Week filter select element ('week-filter') not found for auto-selection.");
                }
            } catch (dateError) {
                console.error("Error calculating or selecting current week:", dateError);
                const weekSelect = document.getElementById('week-filter');
                if (weekSelect && weekSelect.options.length > 1) {
                    weekSelect.selectedIndex = 1;
                } else if (weekSelect) {
                    weekSelect.selectedIndex = 0;
                }
            }
        } else {
            const errorMsg = 'Dados de filtros (turmas/semanas) incompletos ou em formato inesperado recebidos do backend.';
            logDebug(errorMsg, data);
            displayMessage(errorMsg, 'error');
            populateDropdown('turma-filter', [], '-- Erro Turmas --');
            populateDropdown('week-filter', [], '-- Erro Semanas --');
        }
    }
    function onFilterOptionsFailed(error) {
        console.error("Erro na comunica√ß√£o ao carregar filtros:", error);
        displayMessage('Erro na comunica√ß√£o com o servidor ao carregar filtros: ' + error.message, 'error');
        populateDropdown('turma-filter', [], '-- Erro Turmas --');
        populateDropdown('week-filter', [], '-- Erro Semanas --');
    }
    function loadFilteredSchedule() {
        logDebug("loadFilteredSchedule called");
        const turmaFilter = document.getElementById('turma-filter');
        const weekFilter = document.getElementById('week-filter');
        const scheduleContainer = document.getElementById('schedule-container');
        logDebug("Hiding forms and clearing messages before loading new schedule.");
        cancelBookingForm('Reposicao');
        cancelBookingForm('Substituicao');
        cancelAbsenceForm();
        displayMessage('');
        if (scheduleContainer) {
            scheduleContainer.innerHTML = '<p class="info-message">Carregando hor√°rio...</p>';
        } else {
            console.error("Schedule container element not found!");
            displayMessage("Erro interno: Container de hor√°rio n√£o encontrado.", "error");
            return;
        }
        const selectedTurma = turmaFilter ? turmaFilter.value : '';
        const selectedWeek = weekFilter ? weekFilter.value : '';
        logDebug(`Filters selected: Turma='${selectedTurma}', Week='${selectedWeek}'`);
        if (!selectedTurma) {
            logDebug("Validation failed: Turma not selected.");
            displayMessage('Por favor, selecione a Turma.', 'error');
            scheduleContainer.innerHTML = '<p class="info-message">Selecione a Turma e a Semana e clique em "Buscar Hor√°rio".</p>';
            return;
        }
        if (!selectedWeek) {
            logDebug("Validation failed: Week not selected.");
            displayMessage('Por favor, selecione a Semana.', 'error');
            scheduleContainer.innerHTML = '<p class="info-message">Selecione a Turma e a Semana e clique em "Buscar Hor√°rio".</p>';
            return;
        }
        showLoading();
        logDebug("Calling backend: getFilteredScheduleInstances");
        google.script.run
            .withSuccessHandler(onScheduleLoaded)
            .withFailureHandler(onScheduleLoadFailed)
            .getFilteredScheduleInstances(selectedTurma, selectedWeek);
    }
    function onScheduleLoaded(jsonStringResponse) {
        logDebug("onScheduleLoaded called with response string (length):", jsonStringResponse?.length);
        hideLoading();
        const scheduleContainer = document.getElementById('schedule-container');
        if (!scheduleContainer) {
            console.error("Schedule container not found when trying to load data!");
            displayMessage('Erro interno: Container de hor√°rio n√£o encontrado.', 'error');
            return;
        }
        scheduleContainer.innerHTML = '';
        let response;
        try {
            if (!jsonStringResponse) throw new Error("Response string is empty or null.");
            response = JSON.parse(jsonStringResponse);
            logDebug("Filtered schedule response parsed successfully:", response);
        } catch (e) {
            console.error("Erro ao parsear JSON de hor√°rios filtrados:", e, jsonStringResponse);
            displayMessage('Erro ao processar dados de hor√°rios filtrados.', 'error');
            scheduleContainer.innerHTML = '<p class="error-message">Erro ao carregar hor√°rio.</p>';
            return;
        }
        if (!response || !response.success) {
            const errorMessage = (response && response.message) ? response.message : 'Erro desconhecido ao carregar hor√°rios.';
            console.error("Falha ao carregar hor√°rios filtrados:", errorMessage, response);
            displayMessage(errorMessage, 'error');
            scheduleContainer.innerHTML = `<p class="error-message">${errorMessage}</p>`;
            return;
        }
        const responseData = response.data;
        if (!responseData || !Array.isArray(responseData.slots) || typeof responseData.dailyCounts !== 'object') {
            const errorMsg = "Formato de dados inesperado recebido para hor√°rios (esperado objeto com 'slots' e 'dailyCounts').";
            logDebug(errorMsg, responseData);
            displayMessage(errorMsg, 'error');
            scheduleContainer.innerHTML = '<p class="error-message">Erro interno: formato de dados inv√°lido.</p>';
            return;
        }
        const slots = responseData.slots;
        const dailyCounts = responseData.dailyCounts;
        if (slots.length === 0) {
            logDebug("Nenhum hor√°rio encontrado para os filtros selecionados.");
            const noSlotsMessage = response.message && response.message !== 'Hor√°rio carregado com sucesso.'
                ? response.message
                : 'Nenhum hor√°rio encontrado para a turma e semana selecionadas.';
            displayMessage(noSlotsMessage, 'info');
            scheduleContainer.innerHTML = `<p class="info-message">${noSlotsMessage}</p>`;
            return;
        }
        logDebug(`Received ${slots.length} slots and daily counts. Rendering schedule table.`);
        const successMessage = response.message && response.message !== 'Hor√°rio carregado com sucesso.'
            ? response.message
            : `${slots.length} hor√°rios encontrados.`;
        displayMessage(successMessage, 'success');
        renderScheduleTable(slots, scheduleContainer, dailyCounts);
    }
    function onScheduleLoadFailed(error) {
        logDebug("onScheduleLoadFailed called:", error);
        hideLoading();
        console.error("Erro na comunica√ß√£o ao carregar hor√°rios:", error);
        displayMessage('Erro na comunica√ß√£o com o servidor ao buscar hor√°rios: ' + error.message, 'error');
        const scheduleContainer = document.getElementById('schedule-container');
        if (scheduleContainer) {
            scheduleContainer.innerHTML = '<p class="error-message">Erro ao carregar hor√°rio.</p>';
        }
    }
    function offsetDDMMYYYY(dateString, offset) { // band-aid for the issue of date being off by 1 day in some cases
        if (!dateString || typeof dateString !== 'string') return dateString;
        const parts = dateString.split('/');
        if (parts.length === 3) {
            if (!/^\d{2}$/.test(parts[0]) || !/^\d{2}$/.test(parts[1]) || !/^\d{4}$/.test(parts[2])) return dateString;
            const day = parseInt(parts[0], 10) + offset;
            const month = parseInt(parts[1], 10);
            const year = parseInt(parts[2], 10);

            if (year > 1000 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                const dateObj = new Date(year, month - 1, day);
                if (!isNaN(dateObj.getTime()) && dateObj.getFullYear() === year && (dateObj.getMonth() + 1) === month && dateObj.getDate() === day) {
                    const formattedDay = String(day).padStart(2, '0');
                    const formattedMonth = String(month).padStart(2, '0');
                    return `${formattedDay}/${formattedMonth}/${year}`;
                }
            }
        }
        return dateString;
    }
    function renderScheduleTable(slots, containerElement, dailyCounts) {
        logDebug("renderScheduleTable called");
        logDebug(`CurrentUserRole at start of renderScheduleTable: '${currentUserRole}'`);
        logDebug(`TIPOS_HORARIO.FIXO constant value: '${TIPOS_HORARIO.FIXO}'`);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        logDebug(`Today's date (local midnight) for comparison: ${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`);
        const DAY_LIMIT_THRESHOLD = 10;
        const daysOfWeek = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
        const dayIndexMap = { 'Segunda': 0, 'Ter√ßa': 1, 'Quarta': 2, 'Quinta': 3, 'Sexta': 4, 'S√°bado': 5 };
        const gridData = {};
        const uniqueHours = new Set();
        logDebug("Organizing slots into gridData...");
        slots.forEach((slot, index) => {
            if (!slot || !slot.diaSemana || !slot.horaInicio || !slot.hasOwnProperty('statusOcupacao') || !slot.hasOwnProperty('tipoOriginal') || !slot.hasOwnProperty('idInstancia')) {
                console.warn(`Slot inv√°lido ou incompleto encontrado no √≠ndice ${index}, pulando:`, slot);
                return;
            }
            const dayIndex = dayIndexMap[slot.diaSemana];
            if (dayIndex !== undefined) {
                if (!gridData[dayIndex]) {
                    gridData[dayIndex] = {};
                }
                gridData[dayIndex][slot.horaInicio] = slot;
                uniqueHours.add(slot.horaInicio);
            }
        });
        logDebug(`Organized gridData. Found ${uniqueHours.size} unique hours.`);
        const sortedHours = Array.from(uniqueHours).sort((a, b) => a.localeCompare(b));
        const table = document.createElement('table');
        table.classList.add('schedule-grid-table');
        logDebug("Creating table header.");
        const thead = table.createTHead();
        const headerRow = thead.insertRow();
        headerRow.insertCell().outerHTML = "<th>Hor√°rio</th>";
        daysOfWeek.forEach(day => {
            headerRow.insertCell().outerHTML = `<th>${day}</th>`;
        });
        logDebug("Creating table body rows.");
        const tbody = table.createTBody();
        sortedHours.forEach((hour, hourIndex) => {
            const row = tbody.insertRow();
            const hourCell = row.insertCell();
            hourCell.textContent = hour;
            hourCell.classList.add('hour-cell');
            daysOfWeek.forEach((day, dayIndexLoop) => {
                const currentDayIndex = dayIndexMap[day];
                const cell = row.insertCell();
                cell.classList.add('slot-cell');
                const slot = gridData[currentDayIndex] ? gridData[currentDayIndex][hour] : null;
                if (slot) {
                    let mainContentHtml = '';
                    let cellClasses = [];
                    let statusTextForDisplay = slot.statusOcupacao;
                    let possibleBookingType = null;
                    let isClickable = false;
                    const disciplina = slot.disciplinaParaExibir || '';
                    const professorAtual = slot.professorParaExibir || '';
                    const profOriginalBooking = slot.professorOriginalNaReserva || '';
                    const profPrincipalInstance = slot.professorPrincipal || '';
                    const professoresAusentesString = slot.professoresAusentes || '';
                    const tipoAulaReposicao = slot.tipoAulaReposicao || ''; // Novo: tipo de aula de reposi√ß√£o
                    const firstWordDiscipline = disciplina.split(' ')[0] || 'Aula';
                    /*let slotDate = null;
                    try {
                        const dateParts = slot.data.split('/');
                        if (dateParts.length === 3) {
                            // Adicionado +2 para compensar o bug na convers√£o para Date
                            // Para fins de compara√ß√£o, o dia precisa ser exato.
                            // A data da inst√¢ncia j√° vem em UTC, ent√£o podemos criar um objeto Date direto
                            // O new Date(year, month-1, day) cria em local timezone.
                            // Para consist√™ncia, vamos usar Date.UTC para comparar com `today` (que tamb√©m √© UTC midnight)
                            slotDate = new Date(Date.UTC(parseInt(dateParts[2]), parseInt(dateParts[1]) - 1, parseInt(dateParts[0])));
                        }
                    } catch (e) { logAbsenceDebug("Error parsing slot date:", slot.data, e); }*/


                    if (slot.statusOcupacao === STATUS_OCUPACAO.DISPONIVEL) {
                        cellClasses.push('slot-available');
                        if (slot.tipoOriginal === TIPOS_HORARIO.VAGO) {
                            mainContentHtml = `Vago`;
                            cellClasses.push('slot-vago');
                            if (currentUserRole === 'Admin' || currentUserRole === 'Professor') {
                                isClickable = true;
                                possibleBookingType = TIPOS_RESERVA.REPOSICAO; // Reposi√ß√£o √© o tipo de reserva gen√©rico aqui
                                cellClasses.push('clickable-slot', 'clickable-reposicao');
                            }
                        } else if (slot.tipoOriginal === TIPOS_HORARIO.FIXO) {
                            const formattedProfessors = formatProfessorList(profPrincipalInstance, professoresAusentesString);
                            mainContentHtml = `${firstWordDiscipline} - ${formattedProfessors || 'N/D'}`;
                            cellClasses.push('slot-fixo');
                            if (currentUserRole === 'Admin' || currentUserRole === 'Professor') {
                                isClickable = true;
                                possibleBookingType = TIPOS_RESERVA.SUBSTITUICAO;
                                cellClasses.push('clickable-slot', 'clickable-substituicao');
                            }
                        }
                    } else if (slot.statusOcupacao === STATUS_OCUPACAO.REPOSICAO_AGENDADA) {
                        mainContentHtml = `${firstWordDiscipline} - ${professorAtual}`;
                        // Adiciona o tipo de aula (Reposi√ß√£o/Recupera√ß√£o)
                        if (tipoAulaReposicao) {
                            mainContentHtml += `<br><span class="slot-aula-tipo">(${tipoAulaReposicao})</span>`;
                        }
                        cellClasses.push('slot-reposicao', 'slot-booked-public');
                    } else if (slot.statusOcupacao === STATUS_OCUPACAO.SUBSTITUICAO_AGENDADA) {
                        cellClasses.push('slot-substituicao', 'slot-booked-public');
                        let formattedSubstitute = formatProfessorList(professorAtual, professoresAusentesString);
                        const originalToShow = profOriginalBooking || profPrincipalInstance;
                        if (originalToShow && originalToShow !== professorAtual) {
                            let formattedOriginal = formatProfessorList(originalToShow, professoresAusentesString, true);
                            formattedSubstitute = `${formattedSubstitute} (Orig: ${formattedOriginal})`;
                        }
                        mainContentHtml = `${firstWordDiscipline} - ${formattedSubstitute}`;
                    } else {
                        const formattedProfs = formatProfessorList(profPrincipalInstance || professorAtual, professoresAusentesString);
                        mainContentHtml = `${firstWordDiscipline} - ${formattedProfs}`;
                        cellClasses.push('slot-unknown-status');
                        console.warn(`Slot with unknown status encountered: ${slot.statusOcupacao}`, slot);
                    }
                    cell.classList.add(...new Set(cellClasses));
                    let absenceButtonHtml = '';
                    if (slot.tipoOriginal === TIPOS_HORARIO.FIXO && (currentUserRole === 'Admin' || currentUserRole === 'Professor')) {
                        const checkType = slot.tipoOriginal; const constType = TIPOS_HORARIO.FIXO;
                        const typeMatch = checkType === constType; const roleMatchAdmin = currentUserRole === 'Admin';
                        const roleMatchProf = currentUserRole === 'Professor'; const showButtonForAdmin = typeMatch && roleMatchAdmin;
                        const showButtonForProf = typeMatch && roleMatchProf;
                        logAbsenceDebug(`CHECKING Absence Button: ID=${slot.idInstancia}, Date='${slot.data}', Type='${checkType}' (Match: ${typeMatch}), Role='${currentUserRole}', ShowForAdmin=${showButtonForAdmin}, ShowForProf=${showButtonForProf}`);
                        if (showButtonForAdmin || showButtonForProf) {
                            logAbsenceDebug(`-> Preparing Absence Button HTML for Slot ID: ${slot.idInstancia}`);
                            const absenceSlotInfoText = `${slot.data} ${slot.horaInicio} (${slot.diaSemana}) - Turma: ${slot.turma} - Prof(s): ${profPrincipalInstance || 'N/D'}`;
                            const escapedSlotInfo = absenceSlotInfoText.replace(/"/g, '"').replace(/'/g, '\'');
                            const escapedProfessors = (profPrincipalInstance || '').replace(/"/g, '"').replace(/'/g, '\'');
                            absenceButtonHtml = `
                                <div style="margin-top: 4px;">
                                    <button
                                        type="button"
                                        class="action-button report-absence-btn"
                                        title="Informar Aus√™ncia de Professor neste Hor√°rio"
                                        onclick="event.stopPropagation(); showAbsenceForm('${slot.idInstancia}', '${escapedSlotInfo}', '${escapedProfessors}');">
                                        üìÖ‚ùå
                                    </button>
                                </div>`;
                        }
                    }
                    const statusSpanHtml = createStatusSpanHtml(statusTextForDisplay, cellClasses);
                    const mainContentDivHtml = `<div class="slot-main-content">${mainContentHtml}</div>`;
                    cell.innerHTML = `${mainContentDivHtml}${statusSpanHtml}${absenceButtonHtml}`;

                    let tooltipText = `Data: ${offsetDDMMYYYY(slot.data, 1)}\nHora: ${slot.horaInicio}\nTurma: ${slot.turma}\nTipo Original: ${slot.tipoOriginal}\nStatus: ${statusTextForDisplay}`;
                    if (disciplina) tooltipText += `\nDisciplina: ${disciplina}`;
                    if (slot.statusOcupacao === STATUS_OCUPACAO.DISPONIVEL && slot.tipoOriginal === TIPOS_HORARIO.FIXO) {
                        tooltipText += `\nProf. Base: ${profPrincipalInstance || 'N/D'}`;
                    } else if (slot.statusOcupacao === STATUS_OCUPACAO.REPOSICAO_AGENDADA) {
                        tooltipText += `\nProf. Aula: ${professorAtual || 'N/D'}`;
                        if (tipoAulaReposicao) tooltipText += `\nTipo Aula: ${tipoAulaReposicao}`; // Novo: tipo de aula no tooltip
                    } else if (slot.statusOcupacao === STATUS_OCUPACAO.SUBSTITUICAO_AGENDADA) {
                        tooltipText += `\nProf. Substituto: ${professorAtual || 'N/D'}`;
                        const originalToShow = profOriginalBooking || profPrincipalInstance;
                        if (originalToShow && originalToShow !== professorAtual) {
                            tooltipText += `\nProf. Original: ${originalToShow}`;
                        }
                    } else if (profPrincipalInstance) {
                        tooltipText += `\nProf. Base: ${profPrincipalInstance}`;
                    }
                    if (professoresAusentesString) {
                        tooltipText += `\nAusentes: ${professoresAusentesString}`;
                    }
                    tooltipText += `\nID Inst√¢ncia: ${slot.idInstancia}`;
                    cell.title = tooltipText;

                    if (isClickable && possibleBookingType) {
                        const currentIdInstancia = String(slot.idInstancia || '');
                        const currentBookingType = possibleBookingType;
                        let bookingSlotInfoText = `${slot.data} ${slot.horaInicio} (${slot.diaSemana}) - Turma: ${slot.turma}`;
                        if (slot.tipoOriginal === TIPOS_HORARIO.FIXO && profPrincipalInstance) {
                            bookingSlotInfoText += ` - Prof. Base: ${profPrincipalInstance}`;
                        }
                        bookingSlotInfoText += ` - Tipo: ${slot.tipoOriginal}, Status: ${slot.statusOcupacao}`;
                        cell.addEventListener('click', (event) => {
                            if (event.target.closest('.report-absence-btn')) {
                                logDebug("Booking click listener ignored - click was on absence button.");
                                return;
                            }
                            logDebug(`Cell clicked (booking)! Calling selectSlot with ID='${currentIdInstancia}', Type='${currentBookingType}'`);
                            // Passar a hora de in√≠cio para selectSlot para a verifica√ß√£o do almo√ßo
                            selectSlot(currentIdInstancia, currentBookingType, bookingSlotInfoText, slot.horaInicio, slot.turma, slot.data);
                        });
                    }
                } else {
                    cell.classList.add('slot-empty');
                }
            });
        });
        logDebug("Creating table footer for daily counts.");
        const tfoot = table.createTFoot();
        const footerRow = tfoot.insertRow();
        footerRow.classList.add('schedule-summary-row');
        const labelCell = footerRow.insertCell();
        labelCell.outerHTML = `<th class="summary-label">Total (Fixas+Agendadas):</th>`;
        daysOfWeek.forEach(day => {
            const count = dailyCounts[day] !== undefined ? dailyCounts[day] : 0;
            const countCell = footerRow.insertCell();
            countCell.classList.add('summary-count');
            countCell.textContent = count;
            if (count >= DAY_LIMIT_THRESHOLD) {
                countCell.textContent += '*';
                countCell.classList.add('limit-reached');
                countCell.title = `Limite de ${DAY_LIMIT_THRESHOLD} aulas (Fixas+Agendadas) atingido/excedido para este dia.`;
            }
        });
        logDebug("Appending table to schedule-container.");
        containerElement.appendChild(table);
        logDebug("renderScheduleTable finished.");
    }
    function createStatusSpanHtml(statusText, cellClasses) {
        let statusClass = 'status-default';
        if (statusText === STATUS_OCUPACAO.DISPONIVEL) statusClass = 'status-disponivel';
        else if (statusText === STATUS_OCUPACAO.REPOSICAO_AGENDADA) statusClass = 'status-reposicao';
        else if (statusText === STATUS_OCUPACAO.SUBSTITUICAO_AGENDADA) statusClass = 'status-substituicao';
        return `<span class="slot-status ${statusClass}">(${statusText})</span>`;
    }
    function selectSlot(idInstancia, bookingType, slotInfo, slotHoraInicio = null, slotTurma = null, slotData = null) {
        logDebug(`[selectSlot] Function called with: idInstancia='${idInstancia}' (type: ${typeof idInstancia}), bookingType='${bookingType}', currentUserRole='${currentUserRole}', HoraInicio='${slotHoraInicio}', Turma='${slotTurma}', Data='${slotData}'`);
        displayMessage('');
        cancelAbsenceForm();
        if (!idInstancia || String(idInstancia).trim() === '') {
            console.error(`[selectSlot] *** CRITICAL ERROR: Received invalid idInstancia ('${idInstancia}')! Cannot proceed.`);
            displayMessage('Erro interno: ID do hor√°rio selecionado √© inv√°lido.', 'error');
            return;
        }
        if (!bookingType || (bookingType !== TIPOS_RESERVA.REPOSICAO && bookingType !== TIPOS_RESERVA.SUBSTITUICAO)) {
            console.error(`[selectSlot] *** CRITICAL ERROR: Received invalid bookingType ('${bookingType}')! Cannot proceed.`);
            displayMessage('Erro interno: Tipo de agendamento inv√°lido.', 'error');
            return;
        }
        logDebug(`[selectSlot] Checking permissions...`);
        let canBook = false;
        if (bookingType === TIPOS_RESERVA.REPOSICAO && (currentUserRole === 'Admin' || currentUserRole === 'Professor')) {
            canBook = true;
            logDebug("[selectSlot] Permission GRANTED for Reposicao.");
        } else if (bookingType === TIPOS_RESERVA.SUBSTITUICAO && (currentUserRole === 'Admin' || currentUserRole === 'Professor')) {
            canBook = true;
            logDebug("[selectSlot] Permission GRANTED for Substituicao.");
        }
        if (!canBook) {
            const deniedMsg = `Seu perfil (${currentUserRole || 'N/D'}) n√£o permite agendar ${bookingType.toLowerCase()}s.`;
            logDebug(`[selectSlot] Permission DENIED. Role: '${currentUserRole}', Required for '${bookingType}'. Message: ${deniedMsg}`);
            displayMessage(deniedMsg, 'error');
            document.querySelectorAll('.schedule-grid-table td.selected-cell').forEach(cell => cell.classList.remove('selected-cell'));
            return;
        }
        logDebug(`[selectSlot] Applying visual selection for ID: ${idInstancia}`);
        document.querySelectorAll('.schedule-grid-table td.selected-cell').forEach(cell => {
            cell.classList.remove('selected-cell');
        });
        let clickedCell = null;
        try {
            clickedCell = Array.from(document.querySelectorAll('.schedule-grid-table td.clickable-slot'))
                .find(cell => cell.title && cell.title.includes(`ID Inst√¢ncia: ${idInstancia}`));
        } catch (selectorError) {
            console.error("[selectSlot] Error finding clicked cell:", selectorError);
        }
        if (clickedCell) {
            clickedCell.classList.add('selected-cell');
            logDebug("[selectSlot] Added 'selected-cell' class to:", clickedCell);
        } else {
            console.warn("[selectSlot] Could not find the specific table cell to apply visual selection for ID:", idInstancia);
        }
        logDebug(`[selectSlot] Preparing form for type: ${bookingType}`);
        const formPrefix = bookingType.toLowerCase();
        const formDivId = formPrefix + '-form';
        const otherFormDivId = (bookingType === TIPOS_RESERVA.REPOSICAO ? 'substituicao' : 'reposicao') + '-form';
        const formDiv = document.getElementById(formDivId);
        const otherFormDiv = document.getElementById(otherFormDivId);
        const slotIdInput = document.getElementById(formPrefix + '-selected-slot-id');
        const slotInfoSpan = document.getElementById(formPrefix + '-selected-slot-info');
        const professorSelect = document.getElementById(formPrefix + '-professor-real');
        const disciplinaSelect = document.getElementById(formPrefix + '-disciplina');
        // Adicionado para o novo campo tipo de aula (Reposi√ß√£o)
        const tipoAulaSelect = (bookingType === TIPOS_RESERVA.REPOSICAO) ? document.getElementById('reposicao-tipo-aula') : null;

        if (otherFormDiv) {
            logDebug(`[selectSlot] Hiding other form: #${otherFormDivId}`);
            otherFormDiv.style.display = 'none';
        } else {
            console.warn(`[selectSlot] Other form element '#${otherFormDivId}' not found.`);
        }

        let requiredElements = [formDiv, slotIdInput, slotInfoSpan, professorSelect, disciplinaSelect];
        if (bookingType === TIPOS_RESERVA.REPOSICAO) {
            requiredElements.push(tipoAulaSelect);
        }

        if (requiredElements.some(el => !el)) {
            let missingElementIds = [];
            if (!formDiv) missingElementIds.push(formDivId);
            if (!slotIdInput) missingElementIds.push(formPrefix + '-selected-slot-id');
            if (!slotInfoSpan) missingElementIds.push(formPrefix + '-selected-slot-info');
            if (!professorSelect) missingElementIds.push(formPrefix + '-professor-real');
            if (!disciplinaSelect) missingElementIds.push(formPrefix + '-disciplina');
            if (bookingType === TIPOS_RESERVA.REPOSICAO && !tipoAulaSelect) missingElementIds.push('reposicao-tipo-aula');

            console.error(`[selectSlot] One or more form elements not found for booking type '${bookingType}'. Missing IDs: ${missingElementIds.join(', ')}`);
            displayMessage('Erro interno: Componentes do formul√°rio de agendamento n√£o encontrados.', 'error');
            return;
        }

        logDebug(`[selectSlot] All form elements found for type '${bookingType}'.`);
        logDebug(`[selectSlot] Setting hidden input '#${formPrefix}-selected-slot-id' value to: '${idInstancia}'`);
        slotIdInput.value = idInstancia;
        logDebug(`[selectSlot] Value of '#${formPrefix}-selected-slot-id' AFTER setting: '${slotIdInput.value}'`);
        logDebug(`[selectSlot] Setting slot info span text.`);
        slotInfoSpan.textContent = slotInfo;
        logDebug(`[selectSlot] Resetting dropdowns for form '${bookingType}'.`);
        professorSelect.selectedIndex = 0;
        professorSelect.required = true;
        disciplinaSelect.selectedIndex = 0;
        disciplinaSelect.required = true;

        if (tipoAulaSelect) {
            tipoAulaSelect.selectedIndex = 0;
            tipoAulaSelect.required = true;
            // Passar os dados do slot para o formul√°rio para a verifica√ß√£o do almo√ßo
            tipoAulaSelect.dataset.slotHoraInicio = slotHoraInicio;
            tipoAulaSelect.dataset.slotTurma = slotTurma;
            tipoAulaSelect.dataset.slotData = slotData;
        }

        logDebug(`[selectSlot] Displaying form '#${formDivId}' and scrolling into view.`);
        formDiv.style.display = 'block';
        try {
            formDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } catch (scrollError) {
            console.warn("[selectSlot] Scrolling form into view failed:", scrollError);
            formDiv.scrollIntoView();
        }
        logDebug("[selectSlot] finished.");
    }
    function cancelBookingForm(type) {
        logDebug(`cancelBookingForm called for type: ${type}`);
        const formPrefix = type.toLowerCase();
        const formDiv = document.getElementById(formPrefix + '-form');
        if (formDiv) {
            if (formDiv.style.display !== 'none') {
                logDebug(`Hiding form '#${formPrefix}-form'.`);
                formDiv.style.display = 'none';
                logDebug(`Resetting fields for form '#${formPrefix}-form'.`);
                const professorSelect = document.getElementById(formPrefix + '-professor-real');
                const disciplinaSelect = document.getElementById(formPrefix + '-disciplina');
                const slotIdInput = document.getElementById(formPrefix + '-selected-slot-id');
                const slotInfoSpan = document.getElementById(formPrefix + '-selected-slot-info');
                const tipoAulaSelect = (type === 'Reposicao') ? document.getElementById('reposicao-tipo-aula') : null;

                if (professorSelect) professorSelect.selectedIndex = 0;
                if (disciplinaSelect) disciplinaSelect.selectedIndex = 0;
                if (slotIdInput) {
                    logDebug(`Resetting value of '#${formPrefix}-selected-slot-id' from '${slotIdInput.value}' to ''.`);
                    slotIdInput.value = '';
                }
                if (slotInfoSpan) slotInfoSpan.textContent = '';
                if (tipoAulaSelect) {
                    tipoAulaSelect.selectedIndex = 0;
                    delete tipoAulaSelect.dataset.slotHoraInicio;
                    delete tipoAulaSelect.dataset.slotTurma;
                    delete tipoAulaSelect.dataset.slotData;
                }
                logDebug("Booking Form fields reset.");
            }
        } else {
            console.warn(`Form element '#${formPrefix}-form' not found during cancel.`);
        }
        const selectedCells = document.querySelectorAll('.schedule-grid-table td.selected-cell');
        if (selectedCells.length > 0) {
            logDebug("Removing visual selection from grid cells.");
            selectedCells.forEach(cell => cell.classList.remove('selected-cell'));
        }
    }
    function bookSlot(type) {
        logDebug(`bookSlot called for type: ${type}`);
        displayMessage('');
        const formPrefix = type.toLowerCase();
        const slotIdInput = document.getElementById(formPrefix + '-selected-slot-id');
        const professorSelect = document.getElementById(formPrefix + '-professor-real');
        const disciplinaSelect = document.getElementById(formPrefix + '-disciplina');
        const tipoAulaSelect = (type === 'Reposicao') ? document.getElementById('reposicao-tipo-aula') : null;

        let requiredFormElements = [slotIdInput, professorSelect, disciplinaSelect];
        if (type === 'Reposicao') {
            requiredFormElements.push(tipoAulaSelect);
        }

        if (requiredFormElements.some(el => !el)) {
            console.error(`[bookSlot] Critical Error: One or more form input elements not found for type '${type}'. Aborting.`);
            displayMessage(`Erro interno: N√£o foi poss√≠vel encontrar os campos do formul√°rio de ${type}.`, 'error');
            return;
        }

        const slotId = slotIdInput.value;
        const professorReal = professorSelect.value;
        const disciplinaReal = disciplinaSelect.value;
        const tipoAula = (type === 'Reposicao' && tipoAulaSelect) ? tipoAulaSelect.value : null;

        logDebug(`[bookSlot] Reading value from hidden input '#${formPrefix}-selected-slot-id': '${slotId}'`);
        logDebug(`[bookSlot] Reading value from professor select: '${professorReal}'`);
        logDebug(`[bookSlot] Reading value from disciplina select: '${disciplinaReal}'`);
        if (type === 'Reposicao') {
            logDebug(`[bookSlot] Reading value from tipoAula select: '${tipoAula}'`);
        }

        logDebug("[bookSlot] Performing frontend validation...");
        if (!slotId || slotId.trim() === '') {
            console.error(`[bookSlot] Validation failed: slotId is invalid ('${slotId}').`);
            displayMessage('Erro: Nenhum hor√°rio selecionado. Por favor, clique novamente no hor√°rio desejado na grade.', 'error');
            return;
        }
        if (type === 'Reposicao' && (!tipoAula || tipoAula === '')) {
            console.warn(`[bookSlot] Validation failed: Tipo de Aula not selected for Reposicao.`);
            displayMessage(`Por favor, selecione o Tipo de Aula (Reposi√ß√£o ou Recupera√ß√£o Paralela).`, 'error');
            if (tipoAulaSelect) tipoAulaSelect.focus();
            return;
        }
        if (!professorReal || professorReal === '') {
            console.warn(`[bookSlot] Validation failed: Professor not selected.`);
            displayMessage(`Por favor, selecione o Professor para ${type.toLowerCase()}.`, 'error');
            professorSelect.focus();
            return;
        }
        if (!disciplinaReal || disciplinaReal === '') {
            console.warn(`[bookSlot] Validation failed: Disciplina not selected.`);
            displayMessage(`Por favor, selecione a Disciplina para ${type.toLowerCase()}.`, 'error');
            disciplinaSelect.focus();
            return;
        }
        logDebug("[bookSlot] Frontend validation passed.");
        showLoading();

        const bookingDetails = {
            idInstancia: slotId,
            tipoReserva: type, // Mant√©m 'Reposicao' ou 'Substituicao' para l√≥gica de backend
            professorReal: professorReal,
            disciplinaReal: disciplinaReal
        };

        if (type === 'Reposicao') {
            bookingDetails.tipoAulaReposicao = tipoAula; // Adiciona o tipo espec√≠fico da aula
            // Adiciona os dados do slot para a verifica√ß√£o de almo√ßo
            bookingDetails.slotHoraInicio = tipoAulaSelect.dataset.slotHoraInicio;
            bookingDetails.slotTurma = tipoAulaSelect.dataset.slotTurma;
            bookingDetails.slotData = tipoAulaSelect.dataset.slotData;
        }

        const jsonBookingDetailsString = JSON.stringify(bookingDetails);
        logDebug("[bookSlot] Sending booking details to backend:", jsonBookingDetailsString);
        google.script.run
            .withSuccessHandler(onBackendResponse)
            .withFailureHandler(onBookingFailure)
            .bookSlot(jsonBookingDetailsString);
        logDebug("[bookSlot] Backend call initiated.");
    }
    function onBackendResponse(jsonStringResponse) {
        logDebug("onBackendResponse (bookSlot success) called with response string (length):", jsonStringResponse?.length);
        hideLoading();
        let response;
        try {
            if (!jsonStringResponse) throw new Error("Response string is empty or null.");
            response = JSON.parse(jsonStringResponse);
            logDebug("Parsed backend booking response:", response);
        } catch (e) {
            console.error("Erro ao parsear resposta JSON do backend (bookSlot):", e, jsonStringResponse);
            displayMessage("Erro ao processar a resposta do servidor ap√≥s agendamento.", 'error');
            return;
        }
        if (response && response.success) {
            let successMsg = response.message || `Agendamento realizado com sucesso!`;
            if (response.data && response.data.lunchAlert) { // Verifica se h√° alerta de almo√ßo
                successMsg += ` ${response.data.lunchAlert}`; // Adiciona o alerta √† mensagem
            }
            logDebug("Booking successful:", successMsg, response.data);
            displayMessage(successMsg, 'success'); // Mostra a mensagem combinada
            logDebug("Hiding booking forms after successful booking.");
            cancelBookingForm('Reposicao');
            cancelBookingForm('Substituicao');
            logDebug("Reloading schedule grid after successful booking.");
            loadFilteredSchedule();
        } else {
            const errorMessage = response && response.message ? response.message : "Ocorreu um erro desconhecido durante o agendamento.";
            console.error("Backend booking operation failed:", errorMessage, response);
            displayMessage(errorMessage, 'error');
            logDebug("Booking failed on backend. Keeping form open.");
        }
    }
    function onBookingFailure(error) {
        logDebug("onBookingFailure (bookSlot communication error) called:", error);
        hideLoading();
        console.error("Erro na comunica√ß√£o ao agendar:", error);
        displayMessage('Erro na comunica√ß√£o com o servidor ao tentar agendar: ' + error.message, 'error');
        logDebug("Communication failed. Keeping form open.");
    }
    function formatProfessorList(profString, absentString, isOriginal = false) {
        if (!profString) return isOriginal ? '-' : 'N/D';
        const professors = profString.split(',').map(p => p.trim()).filter(p => p);
        const absents = (absentString || '').split(',').map(p => p.trim()).filter(p => p);
        return professors.map(prof => {
            if (absents.includes(prof)) {
                return `<span class="absent-professor" title="${prof} - Ausente">${prof}</span>`;
            }
            return prof;
        }).join(', ');
    }
    function showAbsenceForm(instanceId, slotInfo, professorPrincipalString) {
        logAbsenceDebug(`showAbsenceForm called for Instance ID: ${instanceId}`);
        displayMessage('');
        cancelBookingForm('Reposicao');
        cancelBookingForm('Substituicao');
        const absenceSection = document.getElementById('absence-section');
        const absenceForm = document.getElementById('absence-form');
        const slotIdInput = document.getElementById('absence-selected-slot-id');
        const slotInfoSpan = document.getElementById('absence-selected-slot-info');
        const professorSelect = document.getElementById('absence-professor-select');
        if (!absenceSection || !absenceForm || !slotIdInput || !slotInfoSpan || !professorSelect) {
            console.error("Absence form elements not found!");
            displayMessage('Erro interno: Componentes do formul√°rio de aus√™ncia n√£o encontrados.', 'error');
            return;
        }
        professorSelect.innerHTML = '<option value="" disabled selected>-- Selecione o Professor --</option>';
        const professorsInSlot = professorPrincipalString.split(',').map(p => p.trim()).filter(p => p !== '');
        if (professorsInSlot.length === 0) {
            logAbsenceDebug(`No professors listed in slot ${instanceId} (${professorPrincipalString})`);
            displayMessage('Nenhum professor principal definido para este hor√°rio.', 'error');
            return;
        }
        professorsInSlot.forEach(profName => {
            const option = document.createElement('option');
            option.value = profName;
            option.textContent = profName;
            professorSelect.appendChild(option);
        });
        logAbsenceDebug(`Populated absence dropdown for slot ${instanceId} with: [${professorsInSlot.join(', ')}]`);
        slotIdInput.value = instanceId;
        slotInfoSpan.textContent = slotInfo;
        professorSelect.selectedIndex = 0;
        professorSelect.required = true;
        absenceSection.style.display = 'block';
        absenceForm.style.display = 'block';
        try {
            absenceForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } catch (scrollError) {
            absenceForm.scrollIntoView();
        }
    }
    function cancelAbsenceForm() {
        logAbsenceDebug("cancelAbsenceForm called");
        const absenceForm = document.getElementById('absence-form');
        const slotIdInput = document.getElementById('absence-selected-slot-id');
        const slotInfoSpan = document.getElementById('absence-selected-slot-info');
        const professorSelect = document.getElementById('absence-professor-select');
        if (absenceForm) absenceForm.style.display = 'none';
        if (slotIdInput) slotIdInput.value = '';
        if (slotInfoSpan) slotInfoSpan.textContent = '';
        if (professorSelect) professorSelect.selectedIndex = 0;
    }
    function submitAbsenceReport() {
        logAbsenceDebug("submitAbsenceReport called");
        displayMessage('');
        const slotIdInput = document.getElementById('absence-selected-slot-id');
        const professorSelect = document.getElementById('absence-professor-select');
        if (!slotIdInput || !professorSelect) {
            console.error("Absence form elements missing during submission.");
            displayMessage("Erro interno: Formul√°rio inv√°lido.", "error");
            return;
        }
        const instanceId = slotIdInput.value;
        const professorToMarkAbsent = professorSelect.value;
        if (!instanceId) {
            displayMessage("Erro: ID do hor√°rio n√£o encontrado. Selecione o hor√°rio novamente.", "error");
            return;
        }
        if (!professorToMarkAbsent) {
            displayMessage("Por favor, selecione o professor ausente.", "error");
            professorSelect.focus();
            return;
        }
        logAbsenceDebug(`Submitting absence report for Instance: ${instanceId}, Professor: ${professorToMarkAbsent}`);
        showLoading();
        google.script.run
            .withSuccessHandler(onAbsenceReportResponse)
            .withFailureHandler(onAbsenceReportFailed)
            .reportAbsence(instanceId, professorToMarkAbsent);
    }
    function onAbsenceReportResponse(jsonStringResponse) {
        logAbsenceDebug("onAbsenceReportResponse received:", jsonStringResponse);
        hideLoading();
        let response;
        try {
            response = JSON.parse(jsonStringResponse);
        } catch (e) {
            console.error("Erro ao parsear resposta JSON (Absence Report):", e, jsonStringResponse);
            displayMessage("Erro ao processar resposta do servidor.", 'error');
            return;
        }
        if (response && response.success) {
            displayMessage(response.message || "Aus√™ncia registrada com sucesso!", 'success');
            cancelAbsenceForm();
            logAbsenceDebug("Reloading schedule after successful absence report.");
            loadFilteredSchedule();
        } else {
            const errorMsg = response && response.message ? response.message : "Falha ao registrar aus√™ncia.";
            displayMessage(errorMsg, 'error');
        }
    }
    function onAbsenceReportFailed(error) {
        logAbsenceDebug("onAbsenceReportFailed called:", error);
        hideLoading();
        console.error("Erro na comunica√ß√£o ao registrar aus√™ncia:", error);
        displayMessage('Erro na comunica√ß√£o com o servidor: ' + error.message, 'error');
    }
    document.addEventListener('DOMContentLoaded', function () {
        logDebug("DOMContentLoaded event fired. Starting application initialization.");
        showLoading();
        displayMessage('Carregando dados iniciais...', 'info');
        logDebug("Initiating single call for initial data: getInitialData");
        google.script.run
            .withSuccessHandler(onInitialDataLoaded)
            .withFailureHandler(onInitialDataLoadFailed)
            .getInitialData();
        function onInitialDataLoaded(jsonStringResponse) {
            logDebug("onInitialDataLoaded received response.");
            let response;
            try {
                if (!jsonStringResponse) throw new Error("Response string is empty or null.");
                response = JSON.parse(jsonStringResponse);
                logDebug("Initial data response parsed successfully:", response);
            } catch (e) {
                console.error("Erro ao parsear JSON de dados iniciais:", e, jsonStringResponse);
                onInitialDataLoadFailed({ message: `Erro ao processar dados iniciais: ${e.message}` });
                return;
            }
            hideLoading();
            if (response && response.data) {
                const initialData = response.data;
                let userResponseData = initialData.user || { role: null, email: '[Error]', professorName: null };
                currentUserRole = userResponseData.role;
                currentUserProfessorName = userResponseData.professorName || null;
                logDebug(`Current User Role: ${currentUserRole}, Professor Name: ${currentUserProfessorName}`);
                const userEmailSpan = document.getElementById('user-email');
                const userRoleSpan = document.getElementById('user-role');
                logDebug("Updating user info display...");
                if (userEmailSpan) {
                    userEmailSpan.textContent = userResponseData.email || 'N/A';
                    if (userResponseData.email && userResponseData.email !== '[Error]' && userResponseData.email !== '[Unavailable]') {
                        userEmailSpan.href = `mailto:${userResponseData.email}`;
                    } else {
                        userEmailSpan.href = '#';
                    }
                } else { console.warn("User email span not found."); }
                if (userRoleSpan) {
                    userRoleSpan.textContent = currentUserRole || 'Erro ao Obter';
                } else { console.warn("User role span not found."); }
                if (!currentUserRole && response.success === false) {
                    onInitialDataLoadFailed({ message: response.message || "Falha cr√≠tica ao carregar dados do usu√°rio." });
                    return;
                }
                const professors = Array.isArray(initialData.professors) ? initialData.professors : [];
                logDebug(`Populating professor dropdowns with ${professors.length} professors.`);
                populateDropdown('reposicao-professor-real', professors, '-- Professores --');
                populateDropdown('substituicao-professor-real', professors, '-- Professores --');
                const disciplines = Array.isArray(initialData.disciplines) ? initialData.disciplines : [];
                logDebug(`Populating discipline dropdowns with ${disciplines.length} disciplines.`);
                populateDropdown('reposicao-disciplina', disciplines, '-- Disciplinas --');
                populateDropdown('substituicao-disciplina', disciplines, '-- Disciplinas --');
                const reposicaoSection = document.getElementById('reposicao-section');
                const substituicaoSection = document.getElementById('substituicao-section');
                const absenceSection = document.getElementById('absence-section');
                logDebug("Controlling visibility of sections based on role:", currentUserRole);
                const showBookingForms = (currentUserRole === 'Admin' || currentUserRole === 'Professor');
                const showAbsenceSection = (currentUserRole === 'Admin' || currentUserRole === 'Professor');
                if (reposicaoSection) {
                    reposicaoSection.style.display = showBookingForms ? 'block' : 'none';
                    logDebug(`Reposicao section display set to: ${reposicaoSection.style.display}`);
                } else { console.warn("Reposicao section not found."); }
                if (substituicaoSection) {
                    substituicaoSection.style.display = showBookingForms ? 'block' : 'none';
                    logDebug(`Substituicao section display set to: ${substituicaoSection.style.display}`);
                } else { console.warn("Substituicao section not found."); }
                if (absenceSection) {
                    absenceSection.style.display = showAbsenceSection ? 'block' : 'none';
                    logDebug(`Absence section display set to: ${absenceSection.style.display}`);
                } else {
                    console.warn("Absence section not found.");
                }
                logDebug("Calling loadFilterOptions to populate grid filters.");
                loadFilterOptions();
                const messageDiv = document.getElementById('message');
                if (response.message && response.message !== 'Dados iniciais carregados com sucesso.') {
                    displayMessage(response.message, response.success ? 'info' : 'error');
                } else if (messageDiv && messageDiv.textContent === 'Carregando dados iniciais...') {
                    displayMessage('', 'info');
                }
            } else {
                onInitialDataLoadFailed({ message: (response && response.message) || "Resposta inv√°lida do servidor ao carregar dados iniciais." });
            }
            logDebug("Initialization sequence finished.");
        }
        function onInitialDataLoadFailed(error) {
            hideLoading();
            console.error("Falha no carregamento inicial:", error);
            const errorMsg = `Erro cr√≠tico na inicializa√ß√£o: ${error.message || 'Erro desconhecido'}. A aplica√ß√£o pode n√£o funcionar corretamente.`;
            displayMessage(errorMsg, 'error');
            try {
                const userEmailSpan = document.getElementById('user-email');
                const userRoleSpan = document.getElementById('user-role');
                if (userEmailSpan) userEmailSpan.textContent = 'Erro';
                if (userRoleSpan) userRoleSpan.textContent = 'Erro';
                populateDropdown('turma-filter', [], '-- Erro --');
                populateDropdown('week-filter', [], '-- Erro --');
                populateDropdown('reposicao-professor-real', [], '-- Erro --');
                populateDropdown('substituicao-professor-real', [], '-- Erro --');
                populateDropdown('reposicao-disciplina', [], '-- Erro --');
                populateDropdown('substituicao-disciplina', [], '-- Erro --');
                // Novo: Dropdown de tipo de aula para reposi√ß√£o
                populateDropdown('reposicao-tipo-aula', [
                    { value: "Reposi√ß√£o", text: "Reposi√ß√£o" },
                    { value: "Recupera√ß√£o Paralela", text: "Recupera√ß√£o Paralela" }
                ], '-- Selecione o Tipo de Aula --');

                const filterButton = document.querySelector('.filter-section button');
                if (filterButton) filterButton.disabled = true;
            } catch (uiError) {
                console.error("Error updating UI elements during initial load failure:", uiError);
            }
            const reposicaoSection = document.getElementById('reposicao-section');
            const substituicaoSection = document.getElementById('substituicao-section');
            const absenceSection = document.getElementById('absence-section');
            if (reposicaoSection) reposicaoSection.style.display = 'none';
            if (substituicaoSection) substituicaoSection.style.display = 'none';
            if (absenceSection) absenceSection.style.display = 'none';
        }
    });
    logDebug("Defining global constants: STATUS_OCUPACAO, TIPOS_RESERVA, TIPOS_HORARIO, TIPOS_AULA_REPOSICAO");
    const STATUS_OCUPACAO = Object.freeze({
        DISPONIVEL: 'Disponivel',
        REPOSICAO_AGENDADA: 'Reposicao Agendada',
        SUBSTITUICAO_AGENDADA: 'Substituicao Agendada'
    });
    const TIPOS_RESERVA = Object.freeze({
        REPOSICAO: 'Reposicao',
        SUBSTITUICAO: 'Substituicao'
    });
    const TIPOS_HORARIO = Object.freeze({
        FIXO: 'Fixo',
        VAGO: 'Vago'
    });
    // Novo: Constante para tipos de aula de reposi√ß√£o/recupera√ß√£o no lado do cliente
    const TIPOS_AULA_REPOSICAO = Object.freeze({
        REPOSICAO: 'Reposi√ß√£o',
        RECUPERACAO_PARALELA: 'Recupera√ß√£o Paralela'
    });
</script>